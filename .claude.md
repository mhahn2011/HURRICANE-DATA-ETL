# Hurricane Data ETL - Claude Context

**Last Updated:** 2025-10-05

## Project Overview

This repository extracts **hurricane impact features** for census tract-level analysis, combining HURDAT2 historical hurricane data with US Census TIGER/Line shapefiles to create ML-ready datasets.

### Core Outputs
- Wind speed at census tract centroids (kt)
- Exposure duration (hours above wind thresholds)
- Lead time (hours before reaching category thresholds)
- Distance classifications (within_64kt, within_50kt, within_34kt)

---

## Repository Structure

**Design Principle:** Single-source folders process one data source; multi-source folders combine and transform.

```
hurdat2/                    # Hurricane data processing ONLY
â”œâ”€â”€ src/                   # Parsing, cleaning, envelope generation
â”‚   â”œâ”€â”€ envelope_algorithm.py      # Alpha shape wind coverage envelopes
â”‚   â”œâ”€â”€ parse_raw.py              # HURDAT2 text file parser
â”‚   â””â”€â”€ profile_clean.py          # Data validation & cleaning
â”œâ”€â”€ outputs/
â”‚   â”œâ”€â”€ qa_maps/          # Interactive HTML maps of raw wind fields
â”‚   â”œâ”€â”€ envelopes/        # Envelope visualizations
â”‚   â”œâ”€â”€ transformations/  # Methodology visuals (arc vs chord, imputation)
â”‚   â””â”€â”€ cleaned_data/     # Processed HURDAT2 tables

census/                     # Census tract data ONLY
â”œâ”€â”€ src/                   # Tract loading, centroid extraction
â””â”€â”€ outputs/               # Processed tract centroids

hurdat2_census/            # Storm-tract feature extraction (TRANSFORMATIONS)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ storm_tract_distance.py   # Main pipeline
â”‚   â”œâ”€â”€ wind_interpolation.py     # Wind speed estimation
â”‚   â”œâ”€â”€ duration_calculator.py    # Temporal exposure
â”‚   â””â”€â”€ lead_time_calculator.py   # Warning time features
â””â”€â”€ outputs/
    â”œâ”€â”€ features/          # Intermediate storm-tract CSVs
    â””â”€â”€ transformations/   # QA/QC methodology visuals

integration/                # Final assembly & validation (NO TRANSFORMATIONS)
â”œâ”€â”€ src/
â”‚   â””â”€â”€ feature_pipeline.py       # Assemble final datasets
â””â”€â”€ outputs/
    â”œâ”€â”€ final/             # ML-ready datasets
    â”œâ”€â”€ results/           # Result visualizations
    â””â”€â”€ validation/        # Validation reports
```

---

## Key Algorithms

### 1. Arc-Based Wind Field Geometry âœ… **RECENTLY COMPLETED**

**Critical Fix:** Wind radii are circular arcs, not straight chords.

- **Problem:** Previous chord-based polygons underestimated area by 10-30%
- **Solution:** `generate_quadrant_arc_points()` samples 30 points along 90Â° arcs
- **Status:** Implemented in `envelope_algorithm.py:47-75` and `duration_calculator.py`
- **Next:** Validation comparison (chord vs arc area/tract counts)

**Files Updated:**
- `hurdat2/src/envelope_algorithm.py`
- `hurdat2_census/src/duration_calculator.py`

### 2. Wind Coverage Envelope (Alpha Shapes)

**Purpose:** Create concave hull around wind field extent points

- Uses alpha shape (concave hull) not convex hull
- Samples arc points from NE/SE/SW/NW wind radii
- Segments by `max_gap_km` threshold (default 30km)
- Unions all segments into final envelope

**Implementation:** `envelope_algorithm.py:create_wind_coverage_envelope()`

### 3. Wind Speed Interpolation

**Two-regime model:**
1. **RMW Plateau:** Within radius of max winds â†’ use `max_wind`
2. **Exponential Decay:** Beyond RMW â†’ `max_wind * exp(-0.15 * (distance - rmw) / rmw)`

**Source tracking:** Each tract tagged with `wind_source` (rmw_plateau/decay/missing)

### 4. Duration Calculation

**Method:** 15-minute temporal interpolation between 6-hourly observations

- Creates instantaneous wind polygons at each timestep
- Accumulates hours where tract centroid inside polygon
- Minimum threshold: 0.25 hours (filters noise)

**Source tracking:** Each tract tagged with `duration_source` (imputed/observed)

### 5. Lead Time Features

**Category thresholds:** Cat 1-5 (64kt, 83kt, 96kt, 113kt, 137kt)

For each threshold:
- `lead_time_catN_hours`: Hours before threshold reached
- `lead_time_catN_distance_km`: Distance when threshold reached

---

## Data Quality Transformations

### Wind Radii Imputation

**Problem:** Wind radii often missing (NaN values)

**Solution:** Proportional imputation from most recent valid observation
- Scales by `current_max_wind / reference_max_wind`
- Only forward-fills (never backward)
- Tracks imputed vs observed with `duration_source` column

**Implementation:** `envelope_algorithm.py:impute_wind_radii()`

---

## Recent Development History

**Latest commits:**
1. âœ… Lead time features for category thresholds
2. âœ… Arc-based wind field geometry (replacing chords)
3. âœ… Wind coverage envelope (alpha shapes)
4. âœ… Proportional wind radii imputation
5. âœ… Envelope segmentation refinement

---

## Current Priorities (from IMMEDIATE_TODO.md)

### Priority 1: Visual Documentation & QA/QC
- Update wind field HTML maps to show arcs (not chords)
- Create arc vs chord comparison visual
- Organize visuals into proper folders (qa_maps, transformations, results)

### Priority 2: Repository Structure Cleanup
- âœ… Folder structure defined (completed 2025-10-05)
- Pending: File migrations to new structure
- Pending: Update hardcoded paths in scripts

### Priority 3: Arc Geometry Validation
- Run Ida comparison (chord vs arc)
- Quantify area increase and tract count differences
- Document validation results

### Priority 4: Documentation Updates
- Update FeatureTransformationNarrative.md with arc correction
- Mark arc geometry as complete in workflow docs
- Update ALGORITHM_IMPROVEMENTS_RECOMMENDATIONS.md

---

## Testing

**Test coverage:**
- `tests/test_duration_calculator.py` - Duration calculation
- `tests/test_arc_polygons.py` - Arc polygon generation (NEW)

**Run tests:**
```bash
pytest tests/
```

---

## Key Files to Understand

1. **`REPOSITORY_STRUCTURE.md`** - Folder organization philosophy
2. **`ALGORITHM_IMPROVEMENTS_RECOMMENDATIONS.md`** - Technical methodology review
3. **`ARC_POLYGON_IMPLEMENTATION_PLAN.md`** - Arc geometry implementation details
4. **`IMMEDIATE_TODO.md`** - Current priorities and next actions
5. **`hurdat2/docs/FeatureTransformationNarrative.md`** - Feature methodology narrative

---

## Common Tasks

### Re-run feature extraction for a storm
```bash
python hurdat2_census/src/storm_tract_distance.py --storm AL092021  # Hurricane Ida
```

### Generate QA/QC visualizations
```bash
python hurdat2/src/qaqc_wind_radii_visualization.py
python hurdat2_census/src/qaqc_comprehensive_suite.py
```

### Run full integration pipeline
```bash
python integration/src/feature_pipeline.py
```

---

## Important Conventions

### File Naming
- `{storm_id}_tract_features.csv` - Feature tables
- `qaqc_*.html` - Interactive QA/QC reports
- `{storm_name}_{year}_*.html` - Named storm visualizations

### Script Prefixes
- `parse_*.py` - Data parsing/loading
- `profile_*.py` - Data cleaning/validation
- `envelope_*.py` - Geometric algorithms
- `qaqc_*.py` - Quality assurance
- `*_calculator.py` - Feature calculation modules

### Coordinate Systems
- Input: Decimal degrees (lat/lon)
- Distance calculations: Haversine formula (km)
- Wind radii: Nautical miles in HURDAT2, converted to km

---

## Known Limitations & Future Work

### Completed
- âœ… Arc-based wind field geometry (was underestimating by 10-30%)
- âœ… Wind radii imputation (was creating data gaps)
- âœ… Lead time feature extraction

### In Progress
- ðŸ”„ Arc geometry validation (quantify improvement)
- ðŸ”„ Visual documentation organization

### Future Enhancements
- Add RMW imputation (currently uses 25km default)
- Implement directional wind speed asymmetry
- Add uncertainty bounds for imputed values
- Consider compound features (wind + rainfall + surge)

---

## Development Notes

### When Adding New Features

**If feature requires only HURDAT2 data:**
â†’ Add to `hurdat2/src/`

**If feature requires only census data:**
â†’ Add to `census/src/`

**If feature combines both sources:**
â†’ Add to `hurdat2_census/src/`

**If feature combines multiple transformation outputs:**
â†’ Add to `integration/src/`

### When Adding Visualizations

**Ask: "What does this visualize?"**
- Raw input data â†’ `06_outputs/visuals/hurdat2/` or `01_data_sources/census/outputs/`
- Transformation methodology â†’ `06_outputs/visuals/transformations/`
- Final results â†’ `06_outputs/ml_ready/`

---

## Contact & Resources

- **HURDAT2 Documentation:** https://www.nhc.noaa.gov/data/hurdat/
- **Census TIGER/Line:** https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html
- **Project Issues:** See IMMEDIATE_TODO.md for current work items
